name: Build & Deploy to aidp_whitelabel - Production



on:
  push:
 ยย branches:
 ยยยย - main



jobs:
  build-and-push:
 ยย name: Build & Push to GHCR to main
 ยย runs-on: ubuntu-latest
 ยย environment: prod



 ยย permissions:
 ยยยย contents: read
 ยยยย packages: write



 ยย steps:
 ยยยย - name: Checkout Repository
 ยยยยยย uses: actions/checkout@v4



 ยยยย - name: Log in to GitHub Container Registry (GHCR)
 ยยยยยย uses: docker/login-action@v3
 ยยยยยย with:
 ยยยยยยยย registry: ghcr.io
 ยยยยยยยย username: ${{ secrets.GHCR_USERNAME }}
 ยยยยยยยย password: ${{ secrets.GHCR_TOKEN }}



 ยยยย - name: Set up Docker Buildx
 ยยยยยย uses: docker/setup-buildx-action@v3



 ยยยย - name: Build & Push Docker Image
 ยยยยยย uses: docker/build-push-action@v5
 ยยยยยย with:
 ยยยยยยยย context: .
 ยยยยยยยย push: true
 ยยยยยยยย tags: ghcr.io/ans-mishra/aidp-whitelabel:prod
 ยยยยยยยย build-args: |
 ยยยยยยยยยย API_BASE_URL=${{ secrets.API_BASE_URL }}
 ยยยยยยยยยย MESSAGE_API_URL=${{ secrets.MESSAGE_API_URL }}
 ยยยยยยยยยย CYRENE_AI_ID=${{ secrets.CYRENE_AI_ID }}
 ยยยยยยยยยย TTS_API_URL=${{ secrets.TTS_API_URL }}
 ยยยยยยยยยย MODEL_PROVIDER=${{ secrets.MODEL_PROVIDER }}
 ยยยยยยยยยย OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_PROJECT_ID=${{ secrets.NEXT_PUBLIC_PROJECT_ID }}
 ยยยยยยยยยย NEXT_PUBLIC_HELIUS_API_KEY=${{ secrets.NEXT_PUBLIC_HELIUS_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_SOLANA_RPC_URL=${{ secrets.NEXT_PUBLIC_SOLANA_RPC_URL }}
 ยยยยยยยยยย NEXT_PUBLIC_ALCHEMY_API_KEY=${{ secrets.NEXT_PUBLIC_ALCHEMY_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_TREASURY_ADDRESS=${{ secrets.NEXT_PUBLIC_TREASURY_ADDRESS }}
 ยยยยยยยยยย NEXT_PUBLIC_ADMIN_ADDRESS_1=${{ secrets.NEXT_PUBLIC_ADMIN_ADDRESS_1 }}
 ยยยยยยยยยย NEXT_PUBLIC_ADMIN_ADDRESS_2=${{ secrets.NEXT_PUBLIC_ADMIN_ADDRESS_2 }}
 ยยยยยยยยยย NEXT_PUBLIC_ADMIN_ADDRESS_3=${{ secrets.NEXT_PUBLIC_ADMIN_ADDRESS_3 }}
 ยยยยยยยยยย NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
 ยยยยยยยยยย NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_TWITTER_CLIENT_ID=${{ secrets.NEXT_PUBLIC_TWITTER_CLIENT_ID }}
 ยยยยยยยยยย TWITTER_CLIENT_SECRET=${{ secrets.TWITTER_CLIENT_SECRET }}
 ยยยยยยยยยย NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
 ยยยยยยยยยย NEXT_PUBLIC_BIRDEYE_API_KEY=${{ secrets.NEXT_PUBLIC_BIRDEYE_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_BLOCKEND_API_KEY=${{ secrets.NEXT_PUBLIC_BLOCKEND_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_BLOCKEND_INTEGRATOR_ID=${{ secrets.NEXT_PUBLIC_BLOCKEND_INTEGRATOR_ID }}
 ยยยยยยยยยย NEXT_PUBLIC_LAVAOS_API_KEY=${{ secrets.NEXT_PUBLIC_LAVAOS_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_JITO_TIP_ENDPOINT=${{ secrets.NEXT_PUBLIC_JITO_TIP_ENDPOINT }}
 ยยยยยยยยยย NEXT_PUBLIC_JITO_BUNDLE_ENDPOINT=${{ secrets.NEXT_PUBLIC_JITO_BUNDLE_ENDPOINT }}
 ยยยยยยยยยย NEXT_PUBLIC_JITO_TIP_ACCOUNT=${{ secrets.NEXT_PUBLIC_JITO_TIP_ACCOUNT }}
 ยยยยยยยยยย NEXT_PUBLIC_USE_LOCAL_STREAMING=${{ secrets.NEXT_PUBLIC_USE_LOCAL_STREAMING }}
 ยยยยยยยยยย NEXT_PUBLIC_LOCAL_STREAMING_API=${{ secrets.NEXT_PUBLIC_LOCAL_STREAMING_API }}
 ยยยยยยยยยย NEXT_PUBLIC_SOCKET_URL=${{ secrets.NEXT_PUBLIC_SOCKET_URL }}
 ยยยยยยยยยย NEXT_PUBLIC_ASTRALANE_API_KEY=${{ secrets.NEXT_PUBLIC_ASTRALANE_API_KEY }}
 ยยยยยยยยยย ADDITIONAL_SIGNER_KEY=${{ secrets.ADDITIONAL_SIGNER_KEY }}
 ยยยยยยยยยย UPSTASH_REDIS_REST_URL=${{ secrets.UPSTASH_REDIS_REST_URL }}
 ยยยยยยยยยย UPSTASH_REDIS_REST_TOKEN=${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
 ยยยยยยยยยย SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
 ยยยยยยยยยย DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}ย 
 ยยยยยยยยยย CYRENE_TEAM_ADDRESSES=${{ secrets.CYRENE_TEAM_ADDRESSES }}
 ยยยยยยยยยย HELIUS_API_KEY=${{ secrets.NEXT_PUBLIC_HELIUS_API_KEY }}




  # 2๏ธโฃ Deploy to Both Production Servers
  deploy:
 ยย name: Deploy to Both aidp Servers
 ยย needs: build-and-push
 ยย runs-on: ubuntu-latest
 ยย environment: prod



 ยย # strategy:
 ยย #ยย matrix:
 ยย #ยยยย include:
 ยย #ยยยยยย - name: server1
 ยย #ยยยยยยยย host_secret: PROD_SERVER_1_HOST
 ยย #ยยยยยย - name: server2
 ยย #ยยยยยยยย host_secret: PROD_SERVER_2_HOST
 ยย #ยย max-parallel: 2



 ยย steps:
 ยยยย # - name: Get Server Host from Secrets
 ยยยย #ยย id: get_host
 ยยยย #ยย run: |
 ยยยย #ยยยย if [ "${{ matrix.name }}" = "server1" ]; then
 ยยยย #ยยยยยย echo "host=${{ vars.REMOTE_SERVER_ADDRESS1 }}" >> $GITHUB_OUTPUT
 ยยยย #ยยยย else
 ยยยย #ยยยยยย echo "host=${{ vars.REMOTE_SERVER_ADDRESS2 }}" >> $GITHUB_OUTPUT
 ยยยย #ยยยย fi



 ยยยย # - name: Deploy to ${{ matrix.name }}
 ยยยย - name: Deploy to Production Server



 ยยยยยย uses: appleboy/ssh-action@v0.1.7
 ยยยยยย with:
 ยยยยยยยย # host: ${{ steps.get_host.outputs.host }}
 ยยยยยยยย host: ${{ vars.REMOTE_SERVER_ADDRESS }}
 ยยยยยยยย username: ${{ secrets.SERVER_USERNAME }}
 ยยยยยยยย key: ${{ secrets.REMOTE_SERVER_KEY }}
 ยยยยยยยย port: ${{ secrets.SSH_PORT }}
 ยยยยยยยย script: |
 ยยยยยยยยยย echo "๐ Navigating to home directory..."
 ยยยยยยยยยย mkdir -p aidp_whitelabel && cd aidp_whitelabel



 ยยยยยยยยยย echo "๐ Logging in to GitHub Container Registry (GHCR)..."
 ยยยยยยยยยย echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin





 ยยยยยยยยยย echo "๐ Stopping and removing existing container (if running)..."
 ยยยยยยยยยย docker stop aidp || true
 ยยยยยยยยยย docker rm aidp || true



 ยยยยยยยยยย echo "๐งน Removing old images to free up space..."
 ยยยยยยยยยย docker system prune -f



 ยยยยยยยยยย echo "๐ Pulling the latest production image..."
 ยยยยยยยยยย docker pull ghcr.io/ans-mishra/aidp-whitelabel:prod



 ยยยยยยยยยย echo "๐ Creating environment file..."
 ยยยยยยยยยย cat <<EOF > .env
 ยยยยยยยยยย API_BASE_URL=${{ secrets.API_BASE_URL }}
 ยยยยยยยยยย MESSAGE_API_URL=${{ secrets.MESSAGE_API_URL }}
 ยยยยยยยยยย CYRENE_AI_ID=${{ secrets.CYRENE_AI_ID }}
 ยยยยยยยยยย TTS_API_URL=${{ secrets.TTS_API_URL }}
 ยยยยยยยยยย MODEL_PROVIDER=${{ secrets.MODEL_PROVIDER }}
 ยยยยยยยยยย OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_PROJECT_ID=${{ secrets.NEXT_PUBLIC_PROJECT_ID }}
 ยยยยยยยยยย NEXT_PUBLIC_HELIUS_API_KEY=${{ secrets.NEXT_PUBLIC_HELIUS_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_SOLANA_RPC_URL=${{ secrets.NEXT_PUBLIC_SOLANA_RPC_URL }}
 ยยยยยยยยยย NEXT_PUBLIC_ALCHEMY_API_KEY=${{ secrets.NEXT_PUBLIC_ALCHEMY_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_TREASURY_ADDRESS=${{ secrets.NEXT_PUBLIC_TREASURY_ADDRESS }}
 ยยยยยยยยยย NEXT_PUBLIC_ADMIN_ADDRESS_1=${{ secrets.NEXT_PUBLIC_ADMIN_ADDRESS_1 }}
 ยยยยยยยยยย NEXT_PUBLIC_ADMIN_ADDRESS_2=${{ secrets.NEXT_PUBLIC_ADMIN_ADDRESS_2 }}
 ยยยยยยยยยย NEXT_PUBLIC_ADMIN_ADDRESS_3=${{ secrets.NEXT_PUBLIC_ADMIN_ADDRESS_3 }}
 ยยยยยยยยยย NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
 ยยยยยยยยยย NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_TWITTER_CLIENT_ID=${{ secrets.NEXT_PUBLIC_TWITTER_CLIENT_ID }}
 ยยยยยยยยยย TWITTER_CLIENT_SECRET=${{ secrets.TWITTER_CLIENT_SECRET }}
 ยยยยยยยยยย NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL }}
 ยยยยยยยยยย NEXT_PUBLIC_BIRDEYE_API_KEY=${{ secrets.NEXT_PUBLIC_BIRDEYE_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_BLOCKEND_API_KEY=${{ secrets.NEXT_PUBLIC_BLOCKEND_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_BLOCKEND_INTEGRATOR_ID=${{ secrets.NEXT_PUBLIC_BLOCKEND_INTEGRATOR_ID }}
 ยยยยยยยยยย NEXT_PUBLIC_LAVAOS_API_KEY=${{ secrets.NEXT_PUBLIC_LAVAOS_API_KEY }}
 ยยยยยยยยยย NEXT_PUBLIC_JITO_TIP_ENDPOINT=${{ secrets.NEXT_PUBLIC_JITO_TIP_ENDPOINT }}
 ยยยยยยยยยย NEXT_PUBLIC_JITO_BUNDLE_ENDPOINT=${{ secrets.NEXT_PUBLIC_JITO_BUNDLE_ENDPOINT }}
 ยยยยยยยยยย NEXT_PUBLIC_JITO_TIP_ACCOUNT=${{ secrets.NEXT_PUBLIC_JITO_TIP_ACCOUNT }}
 ยยยยยยยยยย NEXT_PUBLIC_USE_LOCAL_STREAMING=${{ secrets.NEXT_PUBLIC_USE_LOCAL_STREAMING }}
 ยยยยยยยยยย NEXT_PUBLIC_LOCAL_STREAMING_API=${{ secrets.NEXT_PUBLIC_LOCAL_STREAMING_API }}
 ยยยยยยยยยย NEXT_PUBLIC_SOCKET_URL=${{ secrets.NEXT_PUBLIC_SOCKET_URL }}
 ยยยยยยยยยย NEXT_PUBLIC_ASTRALANE_API_KEY=${{ secrets.NEXT_PUBLIC_ASTRALANE_API_KEY }}
 ยยยยยยยยยย ADDITIONAL_SIGNER_KEY=${{ secrets.ADDITIONAL_SIGNER_KEY }}
 ยยยยยยยยยย SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
 ยยยยยยยยยย DISCORD_WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}
 ยยยยยยยยยย CYRENE_TEAM_ADDRESSES=${{ secrets.CYRENE_TEAM_ADDRESSES }}
 ยยยยยยยยยย HELIUS_API_KEY=${{ secrets.NEXT_PUBLIC_HELIUS_API_KEY }}
 ยยยยยยยยยย 
 ยยยยยยยยยย EOF



 ยยยยยยยยยย echo "๐ณ Running the new container..."
 ยยยยยยยยยย docker run -d -p 9089:3000 \
 ยยยยยยยยยยยย --name aidp \
 ยยยยยยยยยยยย --env-file .env \
 ยยยยยยยยยยยย --restart unless-stopped \
 ยยยยยยยยยยยย --label "traefik.enable=true" \
 ยยยยยยยยยยยย --label 'traefik.http.routers.cyreneai-aidp.rule=Host("aidp.cyreneai.com")' \
 ยยยยยยยยยยยย --label "traefik.http.routers.cyreneai-aidp.entrypoints=websecure" \
 ยยยยยยยยยยยย --label "traefik.http.routers.cyreneai-aidp.tls.certresolver=letsencrypt" \
 ยยยยยยยยยยยย --label "traefik.http.services.cyreneai-aidp.loadbalancer.server.port=3000" \
 ยยยยยยยยยยยย --network traefik \
 ยยยยยยยยยยยย ghcr.io/ans-mishra/aidp-whitelabel:prod



 ยยยยยยยยยย echo "โ Deployment complete!"